# Catalog Microservice

Микросервис, отвечающий за логическую структуру файловой системы в распределенном приложении.

## 1. Постановка задачи
Необходимо разработать компонент системы, обеспечивающий организацию и хранение пользовательских файлов в виде иерархической структуры (дерево папок и файлов).

**Ключевые требования:**
* **Абстракция от физического хранения:** Сервис должен управлять только метаданными (имена, структура, права), не касаясь байтов самих файлов.
* **Иерархия:** Поддержка вложенности директорий неограниченной глубины.
* **Безопасность (ACL):** Реализация гибкой ролевой модели доступа. Файлы и папки могут быть приватными, публичными или доступными конкретным пользователям с разными правами (чтение/запись).
* **Производительность:** Быстрый отклик при навигации по каталогам.
* **Интеграция:** Взаимодействие с другими компонентами системы через gRPC.

## 2. Краткое описание решения
Решение реализовано в виде автономного микросервиса на **Python**, использующего **MongoDB** для хранения древовидных структур данных.

**Архитектурные особенности:**
* **Хранение данных:** Использована документ-ориентированная модель (NoSQL), где каждый файл или папка — это документ, содержащий ссылку на родителя (`parent_id`). Это позволяет эффективно выполнять операции перемещения и переименования без перезаписи всего дерева.
* **Модель безопасности:** Логика ACL внедрена непосредственно в бизнес-логику сервиса. Проверка прав происходит на уровне каждого запроса через перехват контекста (Auth Interceptor) и анализ метаданных конкретного объекта (Owner/Writer/Reader lists).
* **Контракт API:** Использование Protobuf и gRPC обеспечивает строгую типизацию данных и высокую производительность межсервисного взаимодействия.

---

## Ключевой функционал

* **Управление метаданными:** Создание, переименование, перемещение и удаление папок и записей о файлах.
* **Иерархическая структура:** Хранение вложенности через ссылки `parent_id`.
* **Access Control List (ACL):** Гранулярная система прав доступа для пользователей и групп.
* **Валидация целостности:** Запрет на удаление непустых папок, проверка существования родительских директорий.

## Технологический стек

* **Язык:** Python 3.14
* **API:** gRPC (Protobuf)
* **Database:** MongoDB (Driver: PyMongo)
* **Testing:** Unittest
* **Containerization:** Docker

## Логика прав доступа (ACL)

Сервис реализует собственную логику проверки прав (`Security Layer`), встроенную в каждый RPC-вызов.

| Роль | Права | Описание |
| :--- | :--- | :--- |
| **Owner** (Владелец) | Full Access | Полный доступ: чтение, запись, удаление, изменение прав. |
| **Writer** (Редактор) | Read + Write | Может переименовывать, добавлять файлы, приглашать читателей. **Не может удалять.** |
| **Reader** (Читатель) | Read Only | Только просмотр содержимого директории. |
| **Guest** (Аноним) | Read Public | Доступ только к объектам с флагом `is_public=True`. |

## Структура модуля

* `server.py` — Точка входа. Содержит:
    * **gRPC Server:** Обработка сетевых запросов.
    * **AuthInterceptor:** Middleware для извлечения токена и валидации сессии.
    * **Service Layer:** Бизнес-логика (CRUD операции).
    * **ACL Methods:** Приватные методы `_can_read` и `_can_write`.
* `catalog.proto` — Contract-first описание API.
* `test_catalog_full.py` — Комплексный набор тестов (функциональные + нагрузочные).
* `Dockerfile` — Инструкции для сборки образа.

## Описание API (gRPC)

Сервис реализует интерфейс `CatalogService`:

* `CreateDirectory` — Создает новую папку (с проверкой прав родителя).
* `RegisterFile` — Регистрирует файл (метаданные) в указанной папке.
* `GetDirectoryContent` — Возвращает список папок и файлов (с фильтрацией по правам доступа).
* `UpdateDirectory` — Переименование, перемещение или изменение списков доступа (`allowed_readers`, `allowed_writers`).
* `DeleteDirectory` — Удаление папки (только если она пуста).
* `DeleteFile` — Удаление метаданных файла.

## Запуск и разработка

Для запуска требуется подключение к MongoDB.

### 1. Сборка контейнера
```bash
docker build -t catalog-service .
